<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home Movie Library ‚Äî TMDb Build</title>
  <!--
    ‚Ä¢ Camera access requires HTTPS (use GitHub Pages).
    ‚Ä¢ TMDb key is hard-coded by request. Anyone can view it in DevTools on a public site.
    ‚Ä¢ UPC ‚Üí title via UPCitemdb (trial). Title/year ‚Üí details via TMDb.
    ‚Ä¢ 9 categories: Genre, Sub‚Äëgenre, Year/Decade, Director, Cast, Format, Language, Country/Region, MPAA.
  -->
  <style>
    :root{--bg:#0f1115;--panel:#151823;--muted:#99a3b3;--text:#e8ecf3;--brand:#6ee7b7;--accent:#60a5fa;--danger:#ef4444;--card:#1a1f2e;--chip:#22283a;--input:#111423;--border:#2a3146}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0e13,#0f1117 20%,#0f1115);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial}
    .app{max-width:1200px;margin:0 auto;padding:20px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{display:flex;align-items:center;gap:12px}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--brand),#4ade80);display:grid;place-items:center;color:#0b1410;font-weight:800}
    h1{font-size:20px;margin:0}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .search{position:relative;flex:1;min-width:240px}
    .search input{width:100%;padding:10px 12px 10px 38px;border-radius:10px;border:1px solid var(--border);background:var(--input);color:var(--text)}
    .search svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);opacity:.7}
    .btn{appearance:none;border:1px solid var(--border);background:var(--panel);color:var(--text);padding:9px 12px;border-radius:10px;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .btn:hover{filter:brightness(1.05)}
    .btn.primary{background:linear-gradient(135deg,#2563eb,#22c55e);border:0}
    .btn.ghost{background:#121522}
    .btn.danger{background:#2b1420;border-color:#7a253f;color:#f9c}
    .filters{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0}
    .chip{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:6px 10px;display:inline-flex;gap:8px;align-items:center}
    .chip input,.chip select{background:transparent;border:0;color:var(--text)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
    .cover{width:100%;height:280px;background:#0c0f18 center/cover no-repeat;display:grid;place-items:center;color:#8891a7}
    .cover small{opacity:.8}
    .card .meta{padding:10px 12px;display:flex;flex-direction:column;gap:6px}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#12202a;border:1px solid #1f3746;color:#9bd1ff;padding:3px 8px;border-radius:999px;font-size:12px}
    .row{display:flex;gap:8px;justify-content:space-between;align-items:center}
    .titleRow{display:flex;gap:8px;align-items:center}
    .titleRow h3{margin:0;font-size:15px;line-height:1.2}
    .shelf{background:#132918;border:1px solid #205c33;color:#b7f6c7;padding:2px 8px;border-radius:999px;font-weight:700}
    .stars{display:inline-flex;gap:2px}
    .empty{opacity:.7;padding:30px;text-align:center;border:1px dashed var(--border);border-radius:16px}
    dialog{border:1px solid var(--border);background:var(--panel);color:var(--text);border-radius:16px;max-width:860px;width:calc(100% - 24px);padding:0}
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:14px;border-bottom:1px solid var(--border)}
    .modal-body{padding:14px}
    .modal-foot{display:flex;justify-content:flex-end;gap:10px;padding:14px;border-top:1px solid var(--border)}
    form.movie{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    form.movie .full{grid-column:1 / -1}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input[type="text"],input[type="number"],input[type="file"],textarea,select{padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--input);color:var(--text)}
    textarea{min-height:90px;resize:vertical}
    .genres{display:flex;flex-wrap:wrap;gap:6px}
    .genres label{display:inline-flex;gap:6px;align-items:center;background:#111524;border:1px solid var(--border);padding:6px 10px;border-radius:999px}
    .help{background:#0f1424;border:1px solid var(--border);border-radius:12px;padding:10px;margin:8px 0;color:#c6d0e0}
    summary{cursor:pointer}
    .pill{background:#14192b;border:1px solid var(--border);padding:6px 10px;border-radius:999px}
    .soft{opacity:.7}
    .hidden{display:none}
    footer{margin-top:18px;opacity:.7;font-size:12px}
  </style>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <div class="logo">üéûÔ∏è</div>
        <div>
          <h1>Home Movie Library</h1>
          <div class="soft">Scan ‚Üí Auto‚Äëadd ‚Üí Auto‚Äëfill from the web (TMDb)</div>
        </div>
      </div>
      <div class="toolbar" style="width:100%">
        <div class="search" style="flex:1">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="q" placeholder="Search (title, cast, tags, synopsis, location, barcode‚Ä¶)" />
        </div>
        <button id="btn-add" class="btn primary">‚ûï Add movie</button>
        <button id="btn-scan" class="btn">üì∑ Scan barcode</button>
        <button id="btn-backup" class="btn">‚§ì Export</button>
        <label class="btn" for="restore">‚§í Import <input id="restore" type="file" accept="application/json" hidden></label>
        <button id="btn-clear" class="btn danger">üóë Delete all</button>
      </div>
    </header>

    <details class="help">
      <summary>Quick help</summary>
      <ul>
        <li><b>9 categories</b>: Genre, Sub‚Äëgenre, Year/Decade, Director, Cast, Format, Language, Country/Region, MPAA.</li>
        <li>Extras: <b>Spine #</b> (auto), <b>Location</b>, <b>Barcode</b>, <b>Cover</b>, <b>Synopsis</b>, <b>Your rating</b>.</li>
      </ul>
    </details>

    <div class="filters">
      <span class="chip">Sort
        <select id="sort">
          <option value="title">Title (A‚ÜíZ)</option>
          <option value="-title">Title (Z‚ÜíA)</option>
          <option value="year">Year ‚Üë</option>
          <option value="-year">Year ‚Üì</option>
          <option value="shelf">Spine # ‚Üë</option>
          <option value="-shelf">Spine # ‚Üì</option>
          <option value="-rating">My rating ‚Üì</option>
          <option value="rating">My rating ‚Üë</option>
        </select>
      </span>
      <span class="chip">Genre <select id="f-genre"><option value="">Any</option></select></span>
      <span class="chip">Sub‚Äëgenre <input id="f-sub" type="text" placeholder="e.g., heist"></span>
      <span class="chip">Format
        <select id="f-format">
          <option value="">Any</option>
          <option>4K UHD</option><option>Blu‚Äëray</option><option>DVD</option><option>Digital</option><option>VHS</option>
        </select>
      </span>
      <span class="chip">Year ‚â• <input id="f-year-min" type="number" placeholder="1990"></span>
      <span class="chip">Decade
        <select id="f-decade"><option value="">Any</option><option>1960s</option><option>1970s</option><option>1980s</option><option>1990s</option><option>2000s</option><option>2010s</option><option>2020s</option></select>
      </span>
      <span class="chip">Language <input id="f-lang" type="text" placeholder="English‚Ä¶"></span>
      <span class="chip">Country/Region <input id="f-country" type="text" placeholder="USA‚Ä¶"></span>
      <span class="chip">MPAA <select id="f-mpaa"><option value="">Any</option><option>G</option><option>PG</option><option>PG-13</option><option>R</option><option>NC-17</option></select></span>
      <span class="chip">Location <input id="f-loc" type="text" placeholder="Room / shelf‚Ä¶"></span>
      <span class="chip">My rating ‚â• <input id="f-rate-min" type="number" min="0" max="5" step="0.5" value="0"></span>
    </div>

    <div id="list" class="grid"></div>
    <div id="empty" class="empty hidden">No movies yet. Click <b>Add movie</b> or <b>Scan barcode</b> to start.</div>

    <footer>This product uses the TMDB API but is not endorsed or certified by TMDB.</footer>
  </div>

  <!-- Add/Edit Modal -->
  <dialog id="editor">
    <form method="dialog" class="movie" id="movie-form">
      <div class="modal-head">
        <strong id="editor-title">Add movie</strong>
        <button class="btn" value="close" type="button" id="btn-close-editor">‚úñ</button>
      </div>
      <div class="modal-body">
        <div class="field"><label>Title</label><input id="title" required></div>
        <div class="field"><label>Year</label><input id="year" type="number" min="1888" max="2100" placeholder="e.g., 1999"></div>
        <div class="field"><label>Director</label><input id="director" placeholder="Name"></div>
        <div class="field"><label>Runtime (min)</label><input id="runtime" type="number" min="1" placeholder="123"></div>

        <div class="field"><label>Format</label>
          <select id="format"><option>4K UHD</option><option>Blu‚Äëray</option><option>DVD</option><option>Digital</option><option>VHS</option></select>
        </div>
        <div class="field"><label>Language</label><input id="language" placeholder="English"></div>
        <div class="field"><label>Country/Region</label><input id="country" placeholder="USA, Japan‚Ä¶"></div>
        <div class="field"><label>MPAA rating</label>
          <select id="mpaa"><option value="">‚Äî</option><option>G</option><option>PG</option><option>PG-13</option><option>R</option><option>NC-17</option></select>
        </div>

        <div class="field full"><label>Genres (choose any)</label>
          <div id="genre-box" class="genres"></div>
        </div>

        <div class="field full"><label>Cast (comma‚Äëseparated)</label><input id="cast" placeholder="Keanu Reeves, Carrie‚ÄëAnne Moss"></div>
        <div class="field full"><label>Sub‚Äëgenres / Tags (comma‚Äëseparated)</label><input id="tags" placeholder="heist, time‚Äëtravel"></div>

        <div class="field"><label>Spine # (auto)</label><input id="shelf" type="number" min="1" placeholder="Auto"></div>
        <div class="field"><label>Location</label><input id="location" placeholder="Room ‚Ä¢ Shelf ‚Ä¢ Row"></div>

        <div class="field"><label>Barcode (UPC/EAN)</label>
          <div style="display:flex;gap:8px"><input id="barcode" placeholder="Scan or type"> <button type="button" id="scan-inside" class="btn">Scan</button></div>
        </div>
        <div class="field"><label>My rating</label>
          <div id="rate-edit" class="stars" role="radiogroup" aria-label="Your rating"></div>
        </div>

        <div class="field full"><label>Synopsis</label>
          <textarea id="synopsis" placeholder="Short plot summary"></textarea>
          <div class="soft" style="margin-top:6px">Synopsis is auto‚Äëfilled from TMDb during scan; you can also type here.</div>
        </div>

        <div class="field full"><label>Cover image</label>
          <div style="display:flex;gap:8px"><input id="cover" type="file" accept="image/*" capture="environment"><button type="button" id="btn-snap" class="btn">üì∏ Use camera</button></div>
          <canvas id="snap-canvas" class="hidden" width="320" height="480"></canvas>
        </div>

        <input id="edit-id" type="hidden">
      </div>
      <div class="modal-foot">
        <button class="btn" type="button" id="btn-cancel">Cancel</button>
        <button id="save" class="btn primary" type="button">üíæ Save</button>
      </div>
    </form>
  </dialog>

  <!-- Details Modal -->
  <dialog id="detail">
    <div class="modal-head">
      <div class="titleRow">
        <span id="d-shelf" class="shelf"></span>
        <strong id="d-title"></strong>
        <span id="d-year" class="pill"></span>
      </div>
      <button class="btn" type="button" id="btn-close-detail">‚úñ</button>
    </div>
    <div class="modal-body">
      <div style="display:flex;gap:8px">
        <img id="d-cover" alt="cover" style="width:220px;height:320px;object-fit:cover;border-radius:12px;border:1px solid var(--border)">
        <div style="flex:1;display:flex;flex-direction:column;gap:10px">
          <div class="badge">Format: <b id="d-format"></b></div>
          <div>Language: <b id="d-lang"></b> ‚Ä¢ Country: <b id="d-country"></b> ‚Ä¢ MPAA: <b id="d-mpaa"></b></div>
          <div>Runtime: <b id="d-run"></b> min</div>
          <div>Director: <b id="d-dir"></b></div>
          <div>Cast: <span id="d-cast" class="soft"></span></div>
          <div>Genres: <span id="d-genres" class="soft"></span></div>
          <div>Sub‚Äëgenres: <span id="d-tags" class="soft"></span></div>
          <div>Barcode: <span id="d-bar" class="pill"></span></div>
          <div>Location: <b id="d-loc"></b></div>
          <div style="display:flex">My rating: <span id="d-rating" class="stars" style="margin-left:6px"></span></div>
        </div>
      </div>
      <div style="margin-top:12px">
        <div class="soft">Synopsis</div>
        <div id="d-syn"></div>
      </div>
    </div>
    <div class="modal-foot">
      <button id="btn-edit" class="btn" type="button">‚úèÔ∏è Edit</button>
      <button id="btn-delete" class="btn danger" type="button">üóë Delete</button>
      <button class="btn" type="button" id="btn-close-detail-2">Close</button>
    </div>
  </dialog>

  <!-- Barcode Scan Modal -->
  <dialog id="scanner">
    <div class="modal-head">
      <strong>Scan barcode</strong>
      <button class="btn" type="button" id="btn-close-scanner">‚úñ</button>
    </div>
    <div class="modal-body">
      <div id="reader" style="width:100%"></div>
      <div class="soft" style="margin-top:10px">Tip: Aim at UPC/EAN. HTTPS required for camera access.</div>
    </div>
  </dialog>

  <script>
  'use strict';
  // ===== Hardcoded TMDb API key & constants =====
  const TMDB_KEY = '64b36c4d3c82e2dbc2264393af1ee56c';
  const TMDB_IMG = 'https://image.tmdb.org/t/p/w500';

  // ===== DOM helpers =====
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const els = {
    list: document.getElementById('list'),
    empty: document.getElementById('empty'),
    q: document.getElementById('q'),
    sort: document.getElementById('sort'),
    editor: document.getElementById('editor'),
    detail: document.getElementById('detail'),
    scanner: document.getElementById('scanner'),
    reader: document.getElementById('reader'),
  };

  const GENRES = ['Action','Adventure','Animation','Biography','Comedy','Crime','Documentary','Drama','Family','Fantasy','Film-Noir','History','Horror','Music','Musical','Mystery','Romance','Sci-Fi','Sport','Thriller','War','Western'];

  // ===== IndexedDB =====
  const DB_NAME = 'movieLibrary.tmdb.v1';
  const STORE = 'movies';
  let db;
  function openDB(){
    return new Promise((res,rej)=>{
      const req = indexedDB.open(DB_NAME,1);
      req.onupgradeneeded = (e)=>{
        const db = e.target.result;
        const st = db.createObjectStore(STORE,{keyPath:'id', autoIncrement:true});
        st.createIndex('title','title',{unique:false});
        st.createIndex('shelf','shelf',{unique:false});
      };
      req.onsuccess = ()=>{db=req.result;res(db)};
      req.onerror = ()=>rej(req.error);
    });
  }
  function tx(mode='readonly'){return db.transaction(STORE,mode).objectStore(STORE)}
  const DB = {
    async all(){return new Promise((res,rej)=>{const r=tx().getAll(); r.onsuccess=()=>res(r.result||[]); r.onerror=()=>rej(r.error)});},
    async add(movie){return new Promise((res,rej)=>{const r=tx('readwrite').add(movie); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error)});},
    async put(movie){return new Promise((res,rej)=>{const r=tx('readwrite').put(movie); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error)});},
    async del(id){return new Promise((res,rej)=>{const r=tx('readwrite').delete(id); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error)});},
    async clear(){return new Promise((res,rej)=>{const r=tx('readwrite').clear(); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error)});},
  };

  let MOVIES = [];
  let CURRENT = null;

  // ===== Utilities =====
  const by = (field, desc=false) => (a,b)=> (a[field]??'') > (b[field]??'') ? (desc? -1:1) : (a[field]??'') < (b[field]??'') ? (desc? 1:-1) : 0;
  function escapeHtml(str){return String(str||'').replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]))}
  function starSVG(fill){return `<svg class="star" width="18" height="18" viewBox="0 0 24 24" fill="${fill? '#fde047':'none'}" stroke="#fde047" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15 9 22 9 17 14 19 21 12 17 5 21 7 14 2 9 9 9 12 2"/></svg>`}
  function renderStars(el, value){ el.innerHTML=''; const v=Number(value||0); for(let i=1;i<=5;i++){ const b=document.createElement('button'); b.type='button'; b.className='star-btn'; b.title=i+' star'; b.innerHTML=starSVG(i<=v); b.onclick=()=>{renderStars(el,i); el.dataset.value=i}; el.appendChild(b);} el.dataset.value=v; }
  function renderStarsStatic(value){let s=''; for(let i=1;i<=5;i++){s+=starSVG(i<=value)} return s}
  function decadeOf(y){ y=Number(y); if(!y) return ''; return Math.floor(y/10)*10 + 's'; }
  function cleanTitle(t){
    return String(t||'')
      .replace(/\s*\((?:blu[-\s]?ray|dvd|uhd|4k|digital|combo|\w+ edition)\)/ig,'')
      .replace(/\s*\[(?:blu[-\s]?ray|dvd|uhd|4k|digital|combo|\w+ edition)\]/ig,'')
      .replace(/\s+\b(4k|uhd|ultra\s*hd|blu[-\s]?ray|dvd|digital|combo|limited|widescreen|\w+ edition)\b/ig,'')
      .replace(/[:\-]\s*(blu[-\s]?ray|dvd|uhd|4k).*/ig,'')
      .replace(/\s{2,}/g,' ')
      .trim();
  }
  function renderGenreChoices(){ const box = document.getElementById('genre-box'); box.innerHTML = GENRES.map(g=>`<label><input type="checkbox" value="${g}"> ${g}</label>`).join(''); const fg = document.getElementById('f-genre'); GENRES.forEach(g=>{const o=document.createElement('option');o.textContent=g; fg.appendChild(o)}); }

  function movieCard(m){
    const cover = m.coverData ? `style="background-image:url('${m.coverData}')"` : '';
    return `<article class="card" data-id="${m.id}">
      <div class="cover" ${cover}>${m.coverData? '' : '<small>No cover</small>'}</div>
      <div class="meta">
        <div class="row"><div class="titleRow"><span class="shelf">#${m.shelf||'‚Äî'}</span><h3>${escapeHtml(m.title||'Untitled')}</h3></div><span class="pill">${m.year||''}</span></div>
        <div class="row"><span class="badge">${escapeHtml(m.format||'')}</span><span class="badge">${escapeHtml(m.language||'')}</span><span class="badge">${escapeHtml(m.country||'')}</span></div>
        <div class="row"><span class="soft">${escapeHtml((m.genres||[]).join(', '))}</span></div>
        <div class="row"><span class="soft">${escapeHtml((m.tags||[]).slice(0,3).join(', '))}</span><span class="stars">${renderStarsStatic(m.rating||0)}</span></div>
        <div class="row"><span class="soft">${escapeHtml(m.location||'')}</span><span class="pill">${escapeHtml(m.mpaa||'')}</span><span class="pill">${escapeHtml(decadeOf(m.year))}</span></div>
      </div>
    </article>`;
  }

  function applyFilters(list){
    const q = els.q.value.trim().toLowerCase();
    const g = document.getElementById('f-genre').value;
    const sub = document.getElementById('f-sub').value.trim().toLowerCase();
    const fmt = document.getElementById('f-format').value;
    const yMin = Number(document.getElementById('f-year-min').value||0);
    const dec = document.getElementById('f-decade').value;
    const lang = document.getElementById('f-lang').value.trim().toLowerCase();
    const country = document.getElementById('f-country').value.trim().toLowerCase();
    const mpaa = document.getElementById('f-mpaa').value;
    const loc = document.getElementById('f-loc').value.trim().toLowerCase();
    const rMin = Number(document.getElementById('f-rate-min').value||0);

    let out = list.filter(m=>{
      let ok = true;
      if(q){
        const hay = [m.title,m.director,m.language,m.format,m.barcode,m.location,m.country,m.mpaa,(m.cast||[]).join(','),(m.tags||[]).join(','),(m.genres||[]).join(','),m.synopsis].join(' ').toLowerCase();
        ok = hay.includes(q);
      }
      if(ok && g){ ok = (m.genres||[]).includes(g) }
      if(ok && sub){ ok = (m.tags||[]).join(' ').toLowerCase().includes(sub) }
      if(ok && fmt){ ok = (m.format||'')===fmt }
      if(ok && yMin){ ok = Number(m.year||0) >= yMin }
      if(ok && dec){ ok = decadeOf(m.year)===dec }
      if(ok && lang){ ok = (m.language||'').toLowerCase().includes(lang) }
      if(ok && country){ ok = (m.country||'').toLowerCase().includes(country) }
      if(ok && mpaa){ ok = (m.mpaa||'')===mpaa }
      if(ok && loc){ ok = (m.location||'').toLowerCase().includes(loc) }
      if(ok && rMin){ ok = Number(m.rating||0) >= rMin }
      return ok;
    });

    const sort = els.sort.value; const desc = sort.startsWith('-'); const key = desc? sort.slice(1): sort; out.sort(by(key, desc));
    return out;
  }

  function renderList(){
    const items = applyFilters(MOVIES);
    if(items.length===0){ els.list.innerHTML=''; els.empty.classList.remove('hidden'); return }
    els.empty.classList.add('hidden');
    els.list.innerHTML = items.map(movieCard).join('');
    $$('#list .card').forEach(card=>{ card.addEventListener('click',()=>openDetail(Number(card.dataset.id))) });
  }

  function nextSpine(){ const max = MOVIES.reduce((mx,m)=>Math.max(mx, Number(m.shelf||0)),0); return max + 1; }

  function openEditor(movie){
    document.getElementById('editor-title').textContent = movie? 'Edit movie' : 'Add movie';
    document.getElementById('edit-id').value = movie? movie.id : '';

    document.getElementById('title').value = movie?.title||'';
    document.getElementById('year').value = movie?.year||'';
    document.getElementById('director').value = movie?.director||'';
    document.getElementById('runtime').value = movie?.runtime||'';
    document.getElementById('format').value = movie?.format||'Blu‚Äëray';
    document.getElementById('language').value = movie?.language||'';
    document.getElementById('country').value = movie?.country||'';
    document.getElementById('mpaa').value = movie?.mpaa||'';

    $$('#genre-box input[type="checkbox"]').forEach(cb=>{ cb.checked = !!(movie?.genres||[]).includes(cb.value) });

    document.getElementById('cast').value = (movie?.cast||[]).join(', ');
    document.getElementById('tags').value = (movie?.tags||[]).join(', ');

    document.getElementById('shelf').value = movie?.shelf || nextSpine();
    document.getElementById('location').value = movie?.location||'';
    document.getElementById('barcode').value = movie?.barcode||'';

    renderStars(document.getElementById('rate-edit'), movie?.rating||0);

    document.getElementById('synopsis').value = movie?.synopsis||'';
    document.getElementById('cover').value = '';
    const canvas = document.getElementById('snap-canvas'); canvas.classList.add('hidden');

    els.editor.showModal();
  }

  async function saveEditor(){
    const id = Number(document.getElementById('edit-id').value||0) || undefined;
    const genres = $$('#genre-box input:checked').map(x=>x.value);
    const cast = document.getElementById('cast').value.split(',').map(x=>x.trim()).filter(Boolean);
    const tags = document.getElementById('tags').value.split(',').map(x=>x.trim()).filter(Boolean);
    const rating = Number(document.getElementById('rate-edit').dataset.value||0);

    const movie = {
      id,
      title: document.getElementById('title').value.trim(),
      year: Number(document.getElementById('year').value||'')||'',
      director: document.getElementById('director').value.trim(),
      runtime: Number(document.getElementById('runtime').value||'')||'',
      format: document.getElementById('format').value,
      language: document.getElementById('language').value.trim(),
      country: document.getElementById('country').value.trim(),
      mpaa: document.getElementById('mpaa').value,
      genres, cast, tags,
      shelf: Number(document.getElementById('shelf').value)||'',
      location: document.getElementById('location').value.trim(),
      barcode: document.getElementById('barcode').value.trim(),
      rating,
      synopsis: document.getElementById('synopsis').value.trim(),
      coverData: await readCoverData()
    };

    if(!movie.title){ alert('Title is required'); return; }

    if(movie.id){
      if(!movie.coverData){ const prev = MOVIES.find(m=>m.id===movie.id); movie.coverData = prev?.coverData||''; }
      await DB.put(movie);
    } else { const newId = await DB.add(movie); movie.id = newId; }

    MOVIES = await DB.all(); renderList(); els.editor.close();
  }

  function readCoverData(){
    return new Promise((res)=>{
      const f = document.getElementById('cover').files?.[0];
      const canvas = document.getElementById('snap-canvas');
      if(f){ const r=new FileReader(); r.onload=()=>res(String(r.result)); r.readAsDataURL(f); return }
      if(!canvas.classList.contains('hidden')){ res(canvas.toDataURL('image/jpeg',0.85)); return }
      res('');
    });
  }

  function openDetail(id){
    const m = MOVIES.find(x=>x.id===id); if(!m) return;
    CURRENT = m;
    document.getElementById('d-title').textContent = m.title||''; document.getElementById('d-year').textContent = m.year||''; document.getElementById('d-shelf').textContent = '#'+(m.shelf||'‚Äî');
    document.getElementById('d-format').textContent = m.format||''; document.getElementById('d-lang').textContent = m.language||''; document.getElementById('d-run').textContent = m.runtime||'';
    document.getElementById('d-country').textContent = m.country||''; document.getElementById('d-mpaa').textContent = m.mpaa||'';
    document.getElementById('d-dir').textContent = m.director||''; document.getElementById('d-cast').textContent = (m.cast||[]).join(', ');
    document.getElementById('d-genres').textContent = (m.genres||[]).join(', ');
    document.getElementById('d-tags').textContent = (m.tags||[]).join(', ');
    document.getElementById('d-bar').textContent = m.barcode||''; document.getElementById('d-loc').textContent = m.location||'';
    document.getElementById('d-rating').innerHTML = renderStarsStatic(m.rating||0);
    document.getElementById('d-syn').textContent = m.synopsis||'';
    document.getElementById('d-cover').src = m.coverData || '';
    els.detail.showModal();
  }

  async function deleteCurrent(){ if(!CURRENT) return; if(!confirm('Delete this movie?')) return; await DB.del(CURRENT.id); CURRENT=null; MOVIES = await DB.all(); renderList(); els.detail.close(); }

  function bindFilters(){
    ['q','f-genre','f-sub','f-format','f-year-min','f-decade','f-lang','f-country','f-mpaa','f-loc','sort','f-rate-min'].forEach(id=>{
      const el = document.getElementById(id); if(!el) return;
      el.addEventListener('input', renderList); el.addEventListener('change', renderList);
    });
    document.getElementById('btn-reset')?.addEventListener('click', ()=>{
      ['q','f-genre','f-sub','f-format','f-year-min','f-decade','f-lang','f-country','f-mpaa','f-loc'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
      const rmin=document.getElementById('f-rate-min'); if(rmin) rmin.value='0'; renderList();
    });
  }

  // ===== Export / Import / Clear =====
  function bindDataButtons(){
    document.getElementById('btn-backup').onclick = ()=>{
      const data = JSON.stringify(MOVIES, null, 2);
      const blob = new Blob([data],{type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'movie-library.json'; a.click(); URL.revokeObjectURL(a.href);
    };
    document.getElementById('restore').addEventListener('change', async e=>{
      const f = e.target.files?.[0]; if(!f) return;
      const text = await f.text();
      try{
        const arr = JSON.parse(text); if(!Array.isArray(arr)) throw new Error('Invalid file');
        await DB.clear(); for(const m of arr){ delete m.id; await DB.add(m) }
        MOVIES = await DB.all(); renderList(); alert('Imported '+arr.length+' movies.');
      }catch(err){ alert('Import failed: '+err.message) }
      e.target.value='';
    });
    document.getElementById('btn-clear').onclick = async()=>{ if(!confirm('Delete ALL movies from this browser?')) return; await DB.clear(); MOVIES=[]; renderList(); };
  }

  // ===== Barcode scanning =====
  let html5Qrcode = null, scanning=false;
  function startScan(){
    if(typeof Html5Qrcode === 'undefined'){ alert('Scanner library not loaded. Enter barcode manually.'); return; }
    els.scanner.showModal();
    const f = {fps:10, qrbox:{width:320,height:160}, aspectRatio:1.8, formatsToSupport:[Html5QrcodeSupportedFormats.EAN_13,Html5QrcodeSupportedFormats.EAN_8,Html5QrcodeSupportedFormats.UPC_A,Html5QrcodeSupportedFormats.UPC_E]};
    html5Qrcode = new Html5Qrcode('reader');
    html5Qrcode.start({facingMode:'environment'}, f, onScanSuccess, onScanError).then(()=>scanning=true).catch(err=>{alert('Camera error: '+err); stopScan(); els.scanner.close();});
  }
  function stopScan(){ if(html5Qrcode && scanning){ html5Qrcode.stop().then(()=>{html5Qrcode.clear(); scanning=false}).catch(()=>{}) } }

  // ===== UPC ‚Üí product ‚Üí TMDb enrichment =====
  async function lookupByUPC(upc){
    const url = `https://api.upcitemdb.com/prod/trial/lookup?upc=${encodeURIComponent(upc)}`;
    try{
      const r = await fetch(url,{headers:{'Accept':'application/json'}});
      if(!r.ok) return null; const j = await r.json();
      if(j && j.code==='OK' && Array.isArray(j.items) && j.items.length){
        const it = j.items[0]||{};
        const title = cleanTitle((it.title||'').trim());
        const cat = (it.category||'').toLowerCase();
        const format = detectFormatFromText(`${title} ${it.description||''} ${cat}`);
        const image = Array.isArray(it.images)&&it.images[0] ? it.images[0] : '';
        return {title, description: it.description||'', image, category: it.category||'', format};
      }
    }catch(e){ console.warn('UPC lookup error',e); }
    return null;
  }
  function detectFormatFromText(txt){ txt=(txt||'').toLowerCase(); if(/\b(4k|uhd|ultra\s*hd)\b/.test(txt)) return '4K UHD'; if(/blu[-\s]?ray/.test(txt)) return 'Blu‚Äëray'; if(/\bdvd\b/.test(txt)) return 'DVD'; if(/vhs/.test(txt)) return 'VHS'; return 'Blu‚Äëray'; }
  function guessYearFromText(t){ const m = String(t||'').match(/\b(19\d{2}|20\d{2})\b/); return m? Number(m[1]): '' }

  async function tmdbSearch(title, year){
    if(!title) return null;
    const url = `https://api.themoviedb.org/3/search/movie?api_key=${TMDB_KEY}&query=${encodeURIComponent(title)}${year?`&year=${encodeURIComponent(year)}`:''}`;
    try{ const r=await fetch(url); const j=await r.json(); if(!j || !Array.isArray(j.results) || j.results.length===0) return null; return j.results[0]; }catch(e){ console.warn('TMDb search error',e); return null }
  }

  async function tmdbEnrich(movie, id){
    const url = `https://api.themoviedb.org/3/movie/${id}?api_key=${TMDB_KEY}&append_to_response=credits,release_dates`;
    try{
      const r = await fetch(url); const d = await r.json(); if(!d || d.success===false) return movie;
      movie.title = d.title || movie.title;
      movie.year = (d.release_date||'').slice(0,4) || movie.year;
      movie.runtime = Number(d.runtime)||movie.runtime||'';
      // Language
      movie.language = (Array.isArray(d.spoken_languages) && d.spoken_languages[0]?.english_name) || d.original_language || movie.language;
      // Country
      movie.country = (Array.isArray(d.production_countries) && d.production_countries[0]?.name) || movie.country;
      // Genres
      movie.genres = Array.isArray(d.genres) ? d.genres.map(g=>g.name) : movie.genres;
      // Director
      if(d.credits && Array.isArray(d.credits.crew)){
        const dir = d.credits.crew.find(c=>c.job==='Director');
        if(dir) movie.director = dir.name;
      }
      // Cast (top 5)
      if(d.credits && Array.isArray(d.credits.cast)){
        movie.cast = d.credits.cast.slice(0,5).map(c=>c.name);
      }
      // MPAA (US certification)
      if(d.release_dates && Array.isArray(d.release_dates.results)){
        const us = d.release_dates.results.find(x=>x.iso_3166_1==='US');
        if(us && Array.isArray(us.release_dates)){
          const cert = us.release_dates.find(x=>x.certification)||us.release_dates[0];
          movie.mpaa = (cert && cert.certification) || movie.mpaa;
        }
      }
      // Overview
      movie.synopsis = d.overview || movie.synopsis;
      // Poster
      if(d.poster_path){ movie.coverData = `${TMDB_IMG}${d.poster_path}`; }
      return movie;
    }catch(e){ console.warn('TMDb detail error',e); return movie }
  }

  async function createMovieFromUPC(code){
    let movie={ barcode:code, shelf:nextSpine(), title:`Barcode ${code}`, year:'', runtime:'', format:'Blu‚Äëray', language:'', country:'', mpaa:'', genres:[], cast:[], tags:[], director:'', rating:0, synopsis:'', coverData:'' };
    const upc=await lookupByUPC(code);
    if(upc && upc.title){ movie.title=upc.title||movie.title; movie.format=upc.format||movie.format; movie.coverData=upc.image||movie.coverData; movie.synopsis=upc.description||movie.synopsis; const y=guessYearFromText(upc.title); if(y) movie.year=y; }
    const found = await tmdbSearch(movie.title, movie.year);
    if(found){ movie = await tmdbEnrich(movie, found.id); }
    const id=await DB.add(movie); movie.id=id; MOVIES=await DB.all(); renderList(); if(els.editor.open) els.editor.close(); openDetail(movie.id);
  }

  async function onScanSuccess(decodedText){
    const code = String(decodedText||'').trim();
    try{ stopScan(); }catch(e){}
    try{ els.scanner.close(); }catch(e){}
    if(!code) return;
    const existing = MOVIES.find(m=>m.barcode===code);
    if(existing){ if(els.editor.open) els.editor.close(); openDetail(existing.id); return; }
    await createMovieFromUPC(code);
  }
  function onScanError(err){ /* silent */ }

  // ===== Camera Cover Snapshot =====
  let stream=null, videoEl=null;
  document.getElementById('btn-snap').onclick = async()=>{
    try{
      if(!navigator.mediaDevices?.getUserMedia){ alert('Camera not supported in this browser.'); return }
      if(!videoEl){ videoEl = document.createElement('video'); videoEl.autoplay=true; videoEl.playsInline=true; videoEl.style.width='100%'; }
      const canvas = document.getElementById('snap-canvas');
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      videoEl.srcObject = stream;
      canvas.replaceWith(videoEl); videoEl.classList.remove('hidden');
      videoEl.onclick = ()=>{
        const c = document.createElement('canvas'); c.width=320; c.height=480; const ctx=c.getContext('2d');
        const r = videoEl.videoWidth / videoEl.videoHeight; const targetR = c.width / c.height; let dw = videoEl.videoWidth, dh = videoEl.videoHeight, sx=0, sy=0;
        if(r>targetR){ dh = videoEl.videoHeight; dw = dh*targetR; sx = (videoEl.videoWidth-dw)/2; } else { dw = videoEl.videoWidth; dh = dw/targetR; sy = (videoEl.videoHeight-dh)/2; }
        ctx.drawImage(videoEl, sx, sy, dw, dh, 0,0,c.width,c.height);
        videoEl.replaceWith(canvas); canvas.classList.remove('hidden');
        canvas.getContext('2d').drawImage(c,0,0);
        stream.getTracks().forEach(t=>t.stop());
      };
    }catch(err){ alert('Camera error: '+err.message) }
  };

  // ===== Init =====
  (async function init(){
    renderGenreChoices();
    await openDB();
    MOVIES = await DB.all();
    renderList();

    // Top bar buttons
    document.getElementById('btn-add').onclick = ()=>openEditor();
    document.getElementById('btn-scan').onclick = startScan;

    bindFilters();
    bindDataButtons();

    // Editor buttons
    document.getElementById('save').onclick = async (e)=>{ e.preventDefault(); e.stopPropagation(); await saveEditor(); };
    document.getElementById('btn-cancel').onclick = ()=>els.editor.close();
    document.getElementById('btn-close-editor').onclick = ()=>els.editor.close();

    // Detail buttons
    document.getElementById('btn-edit').onclick = ()=>{ els.detail.close(); openEditor(CURRENT); };
    document.getElementById('btn-delete').onclick = deleteCurrent;
    document.getElementById('btn-close-detail').onclick = ()=>els.detail.close();
    document.getElementById('btn-close-detail-2').onclick = ()=>els.detail.close();

    // Scanner close
    document.getElementById('btn-close-scanner').onclick = ()=>{ stopScan(); els.scanner.close(); };

    // Inside editor scan trigger
    document.getElementById('scan-inside').onclick = startScan;
  })();
  </script>
</body>
</html>
